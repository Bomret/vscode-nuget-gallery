<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NuGet Gallery</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/3.0.1/mustache.min.js"
        integrity="sha256-srhz/t0GOrmVGZryG24MVDyFDYZpvUH2+dnJ8FbpGi0=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        html,
        body {
            height: 100%;
        }

        select {
            background: var(--vscode-dropdown-background);
            color: var(--vscode-dropdown-foreground);
            border: 1px solid var(--vscode-dropdown-border);
            padding: 3px;
            min-width: 100px;
        }

        input {
            background: var(--vscode-input-background);
            border: var(--vscode-input-border);
            color: var(--vscode-input-foreground);
            padding: 4px;
        }

        button {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            padding: 4px 8px;
            border: 0px;
        }

        button:hover {
            background: var(--vscode-button-hoverBackground);
            cursor: pointer;
        }

        .container {
            display: grid;
            height: 100%;
            grid-template-rows: 60px auto;
            grid-template-columns: 60% 40%;
        }

        .header {
            grid-column: 1 / 3;
            border-bottom: 1px solid var(--vscode-sideBar-border);
        }

        .header>input {
            margin: 10px;
            width: 200px;
        }

        .packages-list {
            grid-row: 2;
            grid-column: 1;
            border-right: 1px solid var(--vscode-sideBar-border);
            overflow: auto;
        }

        .packages-list-item {
            height: 60px;
            margin: 3px;
            display: grid;
            grid-template-columns: 60px auto 60px;
            grid-template-rows: 20px auto;
            grid-gap: 3px;
        }

        .packages-list-item img {
            grid-row: 1 / 3;
            width: 50px;
            height: 50px;
            margin: 5px;
        }

        .package-header {
            grid-row: 1;
            grid-column: 2;

        }

        .package-header .title {
            font-weight: bold;
            font-size: 16px;
        }

        .packages-list-item .package-description {
            grid-column: 2 / 3;
            overflow: hidden;
        }

        .packages-list-item .package-version {
            grid-column: 3;
            margin-right: 2px;
            text-align: right;
        }

        .packages-list-item:hover {
            background: var(--vscode-list-hoverBackground);
            color: var(--vscode-list-hoverForeground);
            cursor: pointer;
        }

        .packages-list-item.selected {
            background: var(--vscode-list-activeSelectionBackground);
            color: var(--vscode-list-activeSelectionForeground);
        }

        .templates {
            display: none;
        }

        #package-info {
            grid-row: 2;
            grid-column: 2;
            overflow: auto;
            margin: 5px;
        }

        #packages-list-items-container .loader {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 30px;
        }

        #package-version-selector {
            margin: 4px;
        }

        .project-version-info {
            margin-top: 4px;
            border-top: 1px solid var(--vscode-sideBar-border);
        }

        .version-badge {
            font-size: 12px;
            font-weight: bold;
            padding: 0px 2px;
            background: var(--vscode-badge-background);
            color: var(--vscode-badge-foreground);
        }

        .package-version-container {
            margin-top: 3px;
            border-top: 1px solid var(--vscode-sideBar-border);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <input id="filter-input"></input>
            <button onclick="filter()">Filter</button>
        </div>
        <div class="packages-list">
            <div id="packages-list-items-container"></div>
        </div>
        <div id="package-info"></div>
    </div>

    <div class="templates">
        <div id="package-info-template">
            <div class="package-header"><span class="title">{{data.id}}</span> by {{data.authorsString}}</div>
            <div class="project-version-info">
                {{#projects}}
                <div>
                    <input onchange="projectSelectionChanged(event, '{{project}}')" type="checkbox">
                    <span>{{project}}</span>
                    {{#version}}
                    <span class="version-badge">{{version}}</span>
                    {{/version}}
                </div>
                {{/projects}}
            </div>
            <div class="package-version-container">
                <select id="package-version-selector">
                    {{#data.versions}}
                    <option value="{{version}}">{{version}}</option>
                    {{/data.versions}}
                </select>
                <button onclick="install()">Install</button>
                <button onclick="uninstall()">Uninstall</button>
            </div>
        </div>
        <div id="loader-template">
            <div class="loader">
                <img src="https://media.giphy.com/media/fAhcc26mNg3vp5jrWt/giphy.gif" />
            </div>
        </div>
        <div id="packages-list-items-template">
            {{#data}}
            <div class="packages-list-item" onclick="selectPackage(this, '{{id}}')">
                {{#iconUrl}}
                <img src="{{iconUrl}}" />
                {{/iconUrl}}
                {{^iconUrl}}
                <img src="https://www.nuget.org/Content/gallery/img/default-package-icon.svg" />
                {{/iconUrl}}
                <div class="package-header"><span class="title">{{id}}</span> by {{authorsString}}</div>
                <div class="package-version">v{{version}}</div>
                {{#summary}}
                <div class="package-description">{{summary}}</div>
                {{/summary}}
                {{^summary}}
                <div class="package-description">{{description}}</div>
                {{/summary}}
            </div>
            {{/data}}
        </div>
    </div>
    </div>

    <script>
        let vscode = acquireVsCodeApi();
        let packages = [];
        let projects = [];
        let selected = null;

        let projectsToUpdate = [];

        function selectPackage(item, id) {
            projectsToUpdate = [];
            if (selected)
                selected.html.classList.remove("selected");

            if (item == null || id == null) {
                selected = null;
                document.getElementById("package-info").innerHTML = "";
            } else {
                let packageData = packages.data.filter(x => x.id == id)[0];
                let packageProjects = projects.map(p => ({
                    project: p.project,
                    path: p.path,
                    version: p.packages.filter(pck => pck.id == packageData.id).length > 0 ?
                        p.packages.filter(pck => pck.id == packageData.id)[0].version : null
                }));
                selected = {
                    html: item,
                    data: packageData,
                    projects: packageProjects
                }
                selected.html.classList.add("selected");

                let template = document.getElementById("package-info-template").innerHTML;
                let result = Mustache.render(template, selected);
                document.getElementById("package-info").innerHTML = result;
            }
        }

        function filter() {
            selectPackage(null, null);
            document.getElementById("packages-list-items-container").innerHTML = document.getElementById(
                "loader-template").innerHTML
            let filterQuery = document.getElementById("filter-input").value;
            axios.get("https://api-v2v3search-0.nuget.org/query", {
                    params: {
                        q: filterQuery
                    }
                })
                .then(response => {
                    packages = response.data;
                    packages.data.forEach(x => {
                        x.authorsString = x.authors.join(", ");
                        x.versions.reverse();
                    });

                    let template = document.getElementById("packages-list-items-template").innerHTML;
                    let result = Mustache.render(template, packages);
                    document.getElementById("packages-list-items-container").innerHTML = result;
                });
        }

        window.addEventListener("message", event => {
            projects = event.data;
            console.log(projects);
        })

        function projectSelectionChanged(ev, project) {
            if (ev.target.checked === true)
                projectsToUpdate.push(project);
            else
                projectsToUpdate = projectsToUpdate.filter(x => x !== project);
        }

        function install() {
            vscode.postMessage({
                command: 'install',
                projects: projectsToUpdate.map(x => projects.find(p => p.project == x)),
                package: selected.data
            })
        }

        function uninstall() {
            vscode.postMessage({
                command: 'uninstall',
                projects: projectsToUpdate.map(x => projects.find(p => p.project == x)),
                package: selected.data
            })
        }

        filter();
    </script>
</body>

</html>